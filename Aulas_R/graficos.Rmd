---
title: "Gráficos"
author: "Beatriz Magiore"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(rcartocolor)
library(utf8)

cores <- carto_pal(12, "Bold")
scales::show_col(cores)
```

## GGPLOT

O conjunto de dados \textit{\textbf{Pokemon}} é composto de variáveis quantitativas e qualitativas. A tabela a seguir mostra o resumo dos dados:

```{r, echo=FALSE}
dados <- read.csv("Dados/Pokemon_full.csv")
summary(dados)
```

### Box-plot

```{r, fig.align='center'}

df <-  dados %>% 
  mutate(
    classe_altura = case_when(
      height < 5 ~ "Baixinho",
      height < 50 ~ "Pequeno",
      height < 100 ~ "Médio",
      TRUE ~ "Altão"
    )
  ) %>% 
  mutate(
    classe_altura = factor(classe_altura, 
                           levels = c("Baixinho", "Pequeno", "Médio", "Altão"))
  )

ggplot(df, aes(x = classe_altura, y = weight, fill = classe_altura))+
  geom_violin()+
  geom_boxplot(width = 0.2, fill = "white")+
    labs(
      x = "Classe altura",
      y = "Peso"
    )+
    scale_y_continuous(trans = "log10")+
    scale_fill_manual(values = cores[c(1,2,3,7)])+
    theme_minimal()+
    theme(
      axis.text = element_text(size = 11),
      axis.title = element_text(size = 13,face = "bold"),
      legend.position = "none"
    )

```
\pagebreak

### Gráfico de pontos

```{r, fig.align='center'}

df %>% 
  arrange(desc(classe_altura)) %>% 
  ggplot(aes(x = weight, y = height, color = classe_altura))+
  geom_point()+
    labs(
      x = "Peso", y = "Altura", color = "Classe altura"
    )+
    guides(color = guide_legend(override.aes = list(size = 3)))+
    scale_x_continuous(trans = "log10")+
    scale_y_continuous(trans = "log10")+
    scale_color_manual(values = cores[c(1,2,3,7)])+
    theme_minimal()+
    theme(
      axis.text = element_text(size = 11),
      axis.title = element_text(size = 13, face = "bold"),
      legend.position = "right",
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 11, face = "bold")
    )

```

\pagebreak

### Gráficos facetados

```{r}

df %>% 
  group_by(classe_altura) %>% 
  summarise(
    media_h = mean(height),
    media_w = mean(weight)
  ) %>% 
  pivot_longer(cols = c(2,3), values_to = "Valor", names_to = "Tipo") %>% 
  mutate(
    Tipo = recode(Tipo,
                  "media_h" = "Média Altura",
                  "media_w" = "Média Peso")
  ) %>% 
  ggplot(aes(x = Tipo, y = Valor, fill = classe_altura))+
  geom_col()+
  labs(
      x = "Tipo", y = "Valor", fill = "Classe Altura"
    )+
  facet_wrap(.~classe_altura)+
  theme_minimal()+
  theme(
      axis.text = element_text(size = 11),
      axis.title = element_text(size = 13,face = "bold"),
      legend.position = "none"
    )

```

### Gráfico de dois eixos

```{r}

df_media <- df %>% 
  group_by(classe_altura) %>% 
  summarise(
    media_h = mean(height),
    media_w = mean(weight)
  ) %>% 
  pivot_longer(cols = c(2,3), values_to = "Valor", names_to = "Tipo") %>% 
  mutate(
    Medida = case_when(
      grepl("_h", Tipo) ~ "Altura",
      TRUE ~ "Peso"
    )
  )

max_altura <- df_media %>% 
  filter(Medida == "Altura") %>% 
  arrange(desc(Valor)) %>% 
  distinct(Medida, .keep_all = TRUE) %>% 
  pull(Valor)

max_peso <- df_media %>% 
  filter(Medida == "Peso") %>% 
  arrange(desc(Valor)) %>% 
  distinct(Medida, .keep_all = TRUE) %>% 
  pull(Valor)

fator = max_peso/max_altura

df_media %>% 
  mutate(
    Valor2 = ifelse(Medida == "Altura", Valor*fator, Valor)
  ) %>% 
  ggplot(aes(x = classe_altura, y = Valor2, fill = Medida))+
  geom_col(position = position_dodge2())+
    labs(
      x = "Classe Altura", y = "Média do Peso", fill = "Média"
    )+
    scale_y_continuous(sec.axis = sec_axis(~./fator, name = "Média da Altura"))+
    theme_minimal()+
    theme(
      axis.text = element_text(size = 11),
      axis.title = element_text(size = 13,face = "bold"),
      legend.position = "none"
    )

```

\pagebreak

## Mapa dengue em SP


```{r, echo=FALSE}
library(sf)
```

```{r}
dados <- read.csv2("Dados/dengue_sp.csv")
head(dados)
```


```{r}

dados <- dados %>% 
  rename(municipio = 1)

```

Garantindo que o conjunto de dados só tenha municípios válidos

```{r}

dados <- dados %>% 
  filter(grepl("^\\d{6}", municipio)) %>% 
  mutate(across(starts_with("x"), as.integer)) %>% 
  replace(is.na(.), 0)

df <- dados %>% 
  pivot_longer(2:13, names_to = "Ano", values_to = "Casos") %>% 
  filter(Ano != "Total") %>% 
  mutate(Ano = str_remove(Ano, "X")) %>% 
  mutate(Cod = str_extract(municipio, "\\d{6}"))

```

Lendo dados da população

```{r}

pop <- read.csv2("Dados/tabela4709.csv", skip = 3)
names(pop) <- c("Cod", "Municipio", "Populacao")

pop <- pop %>% 
  mutate(Cod = str_extract(Cod, "\\d{6}"))
```

```{r}
df <- df %>% 
  left_join(pop) %>% 
  mutate(
    taxa = Casos/Populacao*10000
  )
```

Lendo o arquivo SHP

```{r}
sp_shp <- read_sf("Dados/SHP/cidades_SP.shp")
```


Juntar os dados

```{r}

df <- sp_shp %>% 
  mutate(Cod = str_extract(CD_GEOCODM, "\\d{6}")) %>% 
  select(Cod, geometry) %>% 
  right_join(df)

```

Gráfico

```{r}

ggplot(df)+
  geom_sf(aes(color = taxa))+
  scale_colour_viridis_c()+
  labs(colour = "Taxa de incidencia")+
  facet_wrap(.~Ano)+
  theme_minimal()

```

